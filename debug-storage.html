<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Debug Storage - API Mocker</title>
  <style>
    body {
      font-family: 'Monaco', 'Courier New', monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h2 {
      color: #4ec9b0;
      border-bottom: 2px solid #4ec9b0;
      padding-bottom: 10px;
    }
    .rule {
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
    }
    .rule.enabled {
      border-left: 4px solid #52c41a;
    }
    .rule.disabled {
      border-left: 4px solid #999;
      opacity: 0.6;
    }
    .rule-name {
      font-size: 16px;
      font-weight: bold;
      color: #569cd6;
      margin-bottom: 8px;
    }
    .rule-detail {
      margin: 5px 0;
      font-size: 13px;
    }
    .label {
      color: #9cdcfe;
      font-weight: bold;
    }
    .value {
      color: #ce9178;
    }
    .status-on {
      color: #52c41a;
      font-weight: bold;
    }
    .status-off {
      color: #999;
    }
    pre {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      padding: 10px;
      overflow-x: auto;
      border-radius: 4px;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #1177bb;
    }
    .warning {
      background: #5a3e00;
      border-left: 4px solid #ff8c00;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success {
      background: #0a3d0a;
      border-left: 4px solid #52c41a;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h2>ğŸ” API Mocker Storage è¯Šæ–­å·¥å…·</h2>
  
  <div>
    <button onclick="loadStorage()">ğŸ”„ åˆ·æ–°å­˜å‚¨æ•°æ®</button>
    <button onclick="testMatch()">ğŸ§ª æµ‹è¯• URL åŒ¹é…</button>
    <button onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
  </div>

  <div id="config-section"></div>
  <div id="rules-section"></div>
  <div id="test-section"></div>

  <script>
    async function loadStorage() {
      const data = await chrome.storage.local.get(['mock_config', 'mock_rules', 'mock_scenes', 'mock_records']);
      
      // æ˜¾ç¤ºé…ç½®
      const configHtml = `
        <h2>âš™ï¸ å…¨å±€é…ç½®</h2>
        <pre>${JSON.stringify(data.mock_config || {}, null, 2)}</pre>
      `;
      document.getElementById('config-section').innerHTML = configHtml;
      
      // æ˜¾ç¤ºè§„åˆ™
      const rules = data.mock_rules || [];
      let rulesHtml = `<h2>ğŸ“‹ è§„åˆ™åˆ—è¡¨ (å…± ${rules.length} æ¡)</h2>`;
      
      if (rules.length === 0) {
        rulesHtml += '<div class="warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è§„åˆ™ï¼</div>';
      } else {
        const enabledRules = rules.filter(r => r.enabled);
        rulesHtml += `<div class="${enabledRules.length > 0 ? 'success' : 'warning'}">
          å·²å¯ç”¨: ${enabledRules.length} / ${rules.length}
        </div>`;
        
        rules.forEach((rule, index) => {
          rulesHtml += `
            <div class="rule ${rule.enabled ? 'enabled' : 'disabled'}">
              <div class="rule-name">
                ${index + 1}. ${rule.name} 
                <span class="${rule.enabled ? 'status-on' : 'status-off'}">
                  [${rule.enabled ? 'ON' : 'OFF'}]
                </span>
              </div>
              <div class="rule-detail">
                <span class="label">URL:</span> 
                <span class="value">${rule.url}</span>
              </div>
              <div class="rule-detail">
                <span class="label">åŒ¹é…ç±»å‹:</span> 
                <span class="value">${rule.matchType}</span>
                <span class="label" style="margin-left: 20px;">æ–¹æ³•:</span> 
                <span class="value">${rule.method}</span>
              </div>
              <div class="rule-detail">
                <span class="label">çŠ¶æ€ç :</span> 
                <span class="value">${rule.statusCode}</span>
                <span class="label" style="margin-left: 20px;">å»¶è¿Ÿ:</span> 
                <span class="value">${rule.delay}ms</span>
              </div>
              <div class="rule-detail">
                <span class="label">å“åº”ä½“:</span> 
                <pre style="margin-top: 5px;">${rule.responseBody.substring(0, 200)}${rule.responseBody.length > 200 ? '...' : ''}</pre>
              </div>
            </div>
          `;
        });
      }
      
      document.getElementById('rules-section').innerHTML = rulesHtml;
    }
    
    function testMatch() {
      const testUrl = prompt('è¾“å…¥è¦æµ‹è¯•çš„ URL:', '/app/api/standardList/front/getListData');
      if (!testUrl) return;
      
      const testMethod = prompt('è¾“å…¥ HTTP æ–¹æ³•:', 'POST');
      if (!testMethod) return;
      
      chrome.storage.local.get(['mock_rules', 'mock_config'], (data) => {
        const rules = data.mock_rules || [];
        const config = data.mock_config || { enabled: true };
        
        let testHtml = `
          <h2>ğŸ§ª åŒ¹é…æµ‹è¯•ç»“æœ</h2>
          <div class="rule-detail">
            <span class="label">æµ‹è¯• URL:</span> <span class="value">${testUrl}</span><br>
            <span class="label">æµ‹è¯•æ–¹æ³•:</span> <span class="value">${testMethod}</span><br>
            <span class="label">å…¨å±€å¼€å…³:</span> <span class="${config.enabled ? 'status-on' : 'status-off'}">${config.enabled ? 'ON' : 'OFF'}</span>
          </div>
        `;
        
        // è§„èŒƒåŒ– URL
        function normalizeUrl(url) {
          if (url.startsWith('http://') || url.startsWith('https://')) {
            try {
              const urlObj = new URL(url);
              return urlObj.pathname + urlObj.search + urlObj.hash;
            } catch (e) {
              return url;
            }
          }
          return url;
        }
        
        const normalizedTestUrl = normalizeUrl(testUrl);
        testHtml += `<div class="rule-detail"><span class="label">è§„èŒƒåŒ– URL:</span> <span class="value">${normalizedTestUrl}</span></div>`;
        
        // æµ‹è¯•æ¯ä¸ªè§„åˆ™
        testHtml += '<h3>è§„åˆ™åŒ¹é…è¯¦æƒ…:</h3>';
        let matched = false;
        
        rules.forEach((rule, index) => {
          const normalizedPattern = normalizeUrl(rule.url);
          let isMatch = false;
          let matchReason = '';
          
          if (!rule.enabled) {
            matchReason = 'âŒ è§„åˆ™æœªå¯ç”¨';
          } else if (rule.method !== 'ALL' && rule.method !== testMethod.toUpperCase()) {
            matchReason = `âŒ æ–¹æ³•ä¸åŒ¹é… (è§„åˆ™è¦æ±‚: ${rule.method})`;
          } else {
            // æµ‹è¯•åŒ¹é…
            switch (rule.matchType) {
              case 'exact':
                isMatch = testUrl === rule.url || normalizedTestUrl === normalizedPattern;
                matchReason = isMatch ? 'âœ… ç²¾ç¡®åŒ¹é…æˆåŠŸ' : `âŒ ç²¾ç¡®åŒ¹é…å¤±è´¥`;
                break;
              case 'prefix':
                const prefixPattern = rule.url.replace(/\*$/, '');
                const normalizedPrefixPattern = normalizeUrl(prefixPattern);
                isMatch = testUrl.startsWith(prefixPattern) || normalizedTestUrl.startsWith(normalizedPrefixPattern);
                matchReason = isMatch ? 'âœ… å‰ç¼€åŒ¹é…æˆåŠŸ' : `âŒ å‰ç¼€åŒ¹é…å¤±è´¥`;
                break;
              case 'contains':
                const cleanPattern = rule.url.replace(/^\*+|\*+$/g, '');
                isMatch = testUrl.includes(cleanPattern) || normalizedTestUrl.includes(cleanPattern);
                matchReason = isMatch ? `âœ… åŒ…å«åŒ¹é…æˆåŠŸ (æŸ¥æ‰¾: "${cleanPattern}")` : `âŒ åŒ…å«åŒ¹é…å¤±è´¥ (æŸ¥æ‰¾: "${cleanPattern}")`;
                break;
              case 'regex':
                try {
                  const regex = new RegExp(rule.url);
                  isMatch = regex.test(testUrl) || regex.test(normalizedTestUrl);
                  matchReason = isMatch ? 'âœ… æ­£åˆ™åŒ¹é…æˆåŠŸ' : 'âŒ æ­£åˆ™åŒ¹é…å¤±è´¥';
                } catch (e) {
                  matchReason = `âŒ æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯: ${e.message}`;
                }
                break;
            }
          }
          
          if (isMatch && rule.enabled) matched = true;
          
          testHtml += `
            <div class="rule ${isMatch && rule.enabled ? 'enabled' : 'disabled'}" style="margin: 10px 0;">
              <div class="rule-name">${index + 1}. ${rule.name}</div>
              <div class="rule-detail">
                <span class="label">è§„åˆ™ URL:</span> <span class="value">${rule.url}</span><br>
                <span class="label">åŒ¹é…ç±»å‹:</span> <span class="value">${rule.matchType}</span><br>
                <span class="label">ç»“æœ:</span> <span class="${isMatch ? 'status-on' : 'status-off'}">${matchReason}</span>
              </div>
            </div>
          `;
        });
        
        if (!matched) {
          testHtml = '<div class="warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è§„åˆ™ï¼</div>' + testHtml;
        } else {
          testHtml = '<div class="success">âœ… æ‰¾åˆ°åŒ¹é…çš„è§„åˆ™ï¼</div>' + testHtml;
        }
        
        document.getElementById('test-section').innerHTML = testHtml;
      });
    }
    
    function clearAll() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        chrome.storage.local.clear(() => {
          alert('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼');
          loadStorage();
        });
      }
    }
    
    // è‡ªåŠ¨åŠ è½½
    loadStorage();
  </script>
</body>
</html>

